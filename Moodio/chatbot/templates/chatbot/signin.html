<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- âœ… Responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - Moodio</title>
  {% load static %}
  <link rel="stylesheet" type="text/css" href="{% static 'chatbot/signin.css' %}">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

  <!-- âœ… Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    #user-info {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
      text-align: center;
    }
    #user-info img {
      border-radius: 50%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="logo">Moodio</div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
      <a href="signup.html" class="sign-in" style="color: white;">Sign Up</a>
    </div>
  </nav>

  <!-- Sign In Section -->
  <section class="auth">
    <div class="auth-box">
      <h2>Welcome Back ðŸ‘‹</h2>
      <p class="subtitle">Sign in to continue your learning journey</p>

      <!-- âœ… Google Sign-In Integration -->
      <div 
        id="g_id_onload"
        data-client_id="683217035115-ttukilmm8em59idcetrr04ueogqt5q2f.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-callback="handleCredentialResponse"
        data-auto_prompt="false">
      </div>

      <div class="g_id_signin"
        data-type="standard"
        data-shape="rectangular"
        data-theme="outline"
        data-text="signin_with"
        data-size="large"
        data-logo_alignment="left">
      </div>

      <!-- âœ… User Info after login -->
      <div id="user-info"></div>

      <div class="divider">or with email</div>

      <!-- Normal Sign-In Form -->
      <form method="POST" action="{% url 'chatbot:signin' %}">
        {% csrf_token %}
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>

        <div class="options">
          <label><input type="checkbox"> Keep me logged in</label>
          <a href="#" class="forgot">Forgot password?</a>
        </div>

        <button type="submit" class="btn-primary">Sign In</button>
      </form>

      <p class="switch">Don't have an account? <a href="signup.html">Sign up</a></p>
    </div>

    <!-- Right Side Illustration -->
    <div class="auth-illustration">
      <img src="{% static 'chatbot/images/tiger/tiger_happy.png' %}" alt="AI Learning Illustration">
    </div>
  </section>

  <!-- âœ… JS for Google Login -->
  <script>
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);

      // Show user info
      document.getElementById("user-info").innerHTML = `
        <h3>Welcome, ${data.name}</h3>
        <img src="${data.picture}" alt="Profile picture" width="80"><br>
        <p>Email: ${data.email}</p>
      `;

      console.log("Decoded user info:", data);

      // âœ… Send user data to Django backend
      fetch("{% url 'chatbot:google_signin' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          email: data.email,
          name: data.name,
          picture: data.picture,
        })
      })
      .then(res => res.json())
      .then(result => {
        console.log("Server response:", result);
        if (result.status === "success") {
          window.location.href = "/chatbot/dashboard"; // redirect after login
        }
      })
      .catch(err => console.error("Error:", err));
    }

    // Decode JWT token
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
  </script>

  {% if login_error %}
    <script>
      alert("Invalid email or password. Please try again.");
    </script>
  {% endif %}
</body>
</html>
